import yaml
import wandb
import pickle as pk
from models.ModelFactory import ModelFactory
from utils.data_utils import get_data
from utils.file_utils import get_file_name

# Load configuration file
with open('config.yaml', 'r') as file:
    config = yaml.safe_load(file)

# Start a new wandb run to track this script
wandb.init(
    project="B&M-URLs",
    config=config
)


# Get and preprocess data
X_train, y_train = get_data(config['data']['train_path'], config['data']['features_lexical'], config['data']['target'])
X_test, y_test = get_data(config['data']['test_path'], config['data']['features_lexical'], config['data']['target'])

# Create model
model = ModelFactory.create_model(config['model']['name'], X_train, y_train, X_test, y_test,
                                  config['model']['parameters'])

# Train and predict
model.train()
y_pred = model.predict()

# Save model
file_path = get_file_name('', config['model']['name'])

file = open(file_path, 'wb')
pk.dump(model, file, protocol=pk.HIGHEST_PROTOCOL)

# Calculate evaluation metrics
evals = model.get_evaluation_metrics()

# Log metrics to Wandb
wandb.log(evals)

# Finish the Wandb run
wandb.finish()
